# 学習塾登校管理アプリ 要件定義書

## 1. システム概要

### 1.1 目的
- 生徒のモチベーションアップ
- 講師が生徒の登校状況を理解できる
- 顔と名前が一致しない状況を打破

### 1.2 システム構成
LINE公式アカウント上で動作する登校管理システム
- フロントエンド: LINE Bot (リッチメニュー)
- バックエンド: Node.js/Express
- データ保存: Google Spreadsheet + Supabase
- 通知: メール通知（親向け）

---

## 2. 機能要件

### 2.1 コア機能

#### 2.1.1 登校記録機能（優先度: 高）
**フロー:**
1. 生徒がLINEリッチメニューから「登校」ボタンをタップ
2. 座席番号選択画面を表示（クイックリプライ）
   - オプションA: 1-60の座席番号を直接表示（複数ステップ）
   - オプションB: 教室選択 → 座席番号選択（推奨案）
3. 選択完了後、登校記録を保存
4. 生徒に確認メッセージを送信
5. 親にメール通知を送信

**記録データ:**
- 登校日時（time_stamp）
- 生徒氏名（LINEの登録名/表示名）
- 使用教室
- 座席番号（1-60）

#### 2.1.2 下校記録機能（優先度: 高）
**フロー:**
1. 生徒がLINEリッチメニューから「下校」ボタンをタップ
2. 下校時刻を記録
3. 生徒に確認メッセージを送信
4. （オプション）親にメール通知を送信

#### 2.1.3 登校履歴表示機能（優先度: 高）
**表示内容:**
- 直近1ヶ月の登校記録
- 登校時間・下校時間
- 滞在時間の集計
- 個人ランキング（月間登校時間）
- 全体ランキング（上位10名など）

#### 2.1.4 座席番号管理（優先度: 高）
**要検討事項:**

**案1: 通し番号方式**
- 3教室で1-60の座席に通し番号を振る
- メリット: シンプル
- デメリット: クイックリプライは13個まで → 複数ステップ必要

**案2: 教室→座席選択方式（推奨）**
```
ステップ1: 教室選択
- A教室（1-20）
- B教室（21-40）
- C教室（41-60）

ステップ2: 座席番号選択
- 選択した教室の座席番号を表示
```

**案3: 手入力方式**
- メリット: シンプル
- デメリット: 入力ミスのリスク、ユーザー体験が悪い

### 2.2 付加機能

#### 2.2.1 親向けメール通知（優先度: 中）
- 登校時に「お子様が登校しました」通知
- （オプション）下校時に「お子様が下校しました」通知
- メールアドレスの事前登録が必要

#### 2.2.2 AI先生機能（優先度: 低）
- ChatGPT/Claude APIを活用した質問応答機能
- 生徒からの質問を受付
- 講師にも通知を送信
- AIの回答を生徒に返信

#### 2.2.3 開講日カレンダー（優先度: 低）
- 今月の開講日をPDFで表示
- リッチメニューからアクセス

---

## 3. 非機能要件

### 3.1 パフォーマンス
- LINE Webhook応答時間: 5秒以内
- 同時アクセス: 最大100ユーザー

### 3.2 セキュリティ
- LINE署名検証の実装
- 環境変数による機密情報管理
- Supabase Row Level Security (RLS) の設定

### 3.3 可用性
- 稼働時間: 平日 14:00-22:00, 土日 9:00-18:00
- エラー発生時のログ記録

---

## 4. データ設計

### 4.1 Google Spreadsheet（登校記録）

**シート名: ATTENDANCE_SHEET_NAME**

| カラム名 | データ型 | 説明 |
|---------|---------|-----|
| time_stamp | DateTime | 登校日時 |
| student_name | String | 生徒氏名（LINE表示名） |
| line_user_id | String | LINE User ID |
| classroom | String | 使用教室（A/B/C） |
| seat_number | Integer | 座席番号（1-60） |
| checkout_time | DateTime | 下校日時 |
| duration_minutes | Integer | 滞在時間（分） |

### 4.2 Supabase（ユーザー管理・設定）

**テーブル1: users**
| カラム名 | データ型 | 説明 |
|---------|---------|-----|
| id | UUID | 主キー |
| line_user_id | String | LINE User ID（ユニーク） |
| display_name | String | LINE表示名 |
| parent_email | String | 親のメールアドレス |
| created_at | Timestamp | 作成日時 |
| updated_at | Timestamp | 更新日時 |

**テーブル2: classrooms**
| カラム名 | データ型 | 説明 |
|---------|---------|-----|
| id | UUID | 主キー |
| name | String | 教室名（A/B/C） |
| seat_range_start | Integer | 座席番号開始 |
| seat_range_end | Integer | 座席番号終了 |

**テーブル3: webhook_logs**
| カラム名 | データ型 | 説明 |
|---------|---------|-----|
| id | UUID | 主キー |
| event_type | String | イベント種別 |
| payload | JSONB | Webhookペイロード |
| created_at | Timestamp | 受信日時 |

---

## 5. UI/UX設計

### 5.1 LINEリッチメニュー構成

```
┌─────────┬─────────┬─────────┐
│         │         │         │
│  登校   │  下校   │ 登校履歴 │
│         │         │         │
├─────────┴─────────┴─────────┤
│          （下段は将来拡張用）    │
│   AI先生  │  カレンダー  │     │
└─────────┴─────────┴─────────┘
```

### 5.2 メッセージフロー例

**登校フロー:**
```
生徒: [登校]ボタンをタップ

Bot: どの教室を使いますか？
     [A教室] [B教室] [C教室]

生徒: [A教室]をタップ

Bot: 座席番号を選択してください
     [1] [2] [3] [4] [5] [6] [7] [8] [9] [10]
     [11] [12] [13] ▼もっと見る

生徒: [5]をタップ

Bot: ✅ 登校を記録しました！
     教室: A教室
     座席: 5番
     時刻: 2025/11/06 15:30

     今日も頑張りましょう！
```

---

## 6. 技術スタック

### 6.1 バックエンド
- **言語**: Node.js (推奨: v18以上)
- **フレームワーク**: Express.js
- **ホスティング**: Heroku / Vercel / Cloud Run（要決定）

### 6.2 データベース/ストレージ
- **Google Sheets API**: 登校記録の保存
- **Supabase**: ユーザー情報、Webhook管理

### 6.3 外部API
- **LINE Messaging API**: Bot機能
- **OpenAI API / Claude API**: AI先生機能（オプション）
- **SendGrid / Gmail API**: メール通知

### 6.4 開発ツール
- **パッケージマネージャー**: npm / yarn
- **環境変数管理**: dotenv
- **テスト**: Jest（オプション）

---

## 7. 実装優先度とマイルストーン

### Phase 1: MVP（最小実行可能製品）
- ✅ 登校記録機能（座席番号選択含む）
- ✅ 下校記録機能
- ✅ Google Spreadsheetへのデータ保存
- ✅ リッチメニューの設定

### Phase 2: 基本機能拡張
- ✅ 登校履歴表示
- ✅ ランキング表示
- ✅ 親向けメール通知

### Phase 3: 追加機能
- ✅ AI先生機能
- ✅ 開講日カレンダー
- ✅ 管理画面（講師向け）

---

## 8. 検討事項・未決定事項

### 8.1 座席番号選択方式
- [ ] 案1（通し番号）vs 案2（教室→座席）の最終決定
- [ ] 各教室の座席数の確定（現在は仮で1-20, 21-40, 41-60）

### 8.2 メール通知
- [ ] 親のメールアドレス登録方法（初回登録フロー）
- [ ] 下校時も通知するか？

### 8.3 ランキング表示
- [ ] ランキングの集計期間（日次/週次/月次）
- [ ] ランキング表示のタイミング（リアルタイム/日次更新）
- [ ] プライバシー配慮（フルネーム表示 vs イニシャル）

### 8.4 運用
- [ ] ホスティング先の決定
- [ ] ドメイン/SSL証明書
- [ ] ログ監視・エラー通知の仕組み

---

## 9. 次のステップ

1. **検討事項の決定**: 8章の未決定事項を確定
2. **プロジェクト構成の作成**: ディレクトリ構造、package.json
3. **Supabaseテーブル作成**: DDL実行
4. **Google Sheets設定**: API有効化、認証情報取得
5. **LINE Bot設定**: チャネル作成、Webhook設定
6. **開発開始**: Phase 1から順次実装
