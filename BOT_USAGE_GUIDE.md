# LINE Bot 使い方ガイド

## Botの動作説明

### 現在の実装状況

このBotは**リッチメニュー**からの操作を想定して作られています。
テキストメッセージにも一部対応していますが、基本はリッチメニューのボタンを押して使います。

---

## ✅ リッチメニューから使う場合（推奨）

### 1. 友だち追加したとき

**送信**: （友だち追加）

**返信**:
```
学習塾登校管理システムへようこそ！

リッチメニューから操作してください。
・登校: 教室に着いたら押してください
・下校: 帰るときに押してください
・登校履歴: あなたの記録を確認できます
```

---

### 2. 登校ボタンを押したとき

#### ステップ1: 登校ボタンをタップ

**操作**: リッチメニューの「登校」をタップ

**返信**:
```
どの教室を使いますか？

[A教室] [B教室] [C教室]
（クイックリプライで表示）
```

#### ステップ2: 教室を選択

**操作**: 例えば「A教室」をタップ

**返信**:
```
A教室の座席番号を選択してください

[1番] [2番] [3番] ... [13番] [もっと見る]
（クイックリプライで表示）
```

#### ステップ3: 座席番号を選択

**操作**: 例えば「5番」をタップ

**返信**:
```
✅ 登校を記録しました！

教室: A教室
座席: 5番
時刻: 2025/11/06 15:30

今日も頑張りましょう！
```

**Google Sheetsに記録される内容**:
```
| time_stamp          | student_name | line_user_id | classroom | seat_number | checkout_time | duration_minutes |
|---------------------|--------------|--------------|-----------|-------------|---------------|------------------|
| 2025-11-06 15:30:00 | 山田太郎     | U1234567890  | A教室     | 5           |               |                  |
```

---

### 3. 下校ボタンを押したとき

#### ステップ1: 下校ボタンをタップ

**操作**: リッチメニューの「下校」をタップ

**返信**:
```
下校しますか？

[はい、下校します] [キャンセル]
（クイックリプライで表示）
```

#### ステップ2: 確認

**操作**: 「はい、下校します」をタップ

**返信**:
```
✅ 下校を記録しました！

勉強時間: 2時間30分

お疲れ様でした！
```

**Google Sheetsが更新される**:
```
| time_stamp          | ... | checkout_time       | duration_minutes |
|---------------------|-----|---------------------|------------------|
| 2025-11-06 15:30:00 | ... | 2025-11-06 18:00:00 | 150              |
```

---

### 4. 登校履歴ボタンを押したとき

**操作**: リッチメニューの「登校履歴」をタップ

**返信**: Flex Message（リッチな表示形式）
```
┌─────────────────────────┐
│ 📊 登校履歴              │
├─────────────────────────┤
│ 2025-11-06    2時間30分 │
│ 2025-11-05    3時間15分 │
│ 2025-11-04    登校中     │
│ 2025-11-03    2時間45分 │
│ 2025-11-02    4時間00分 │
└─────────────────────────┘
```

---

## ✅ テキストメッセージで使う場合（フォールバック）

リッチメニューが無い場合や、直接入力したい場合に使えます。

### 対応しているテキストコマンド

| 送信するテキスト | 動作 |
|----------------|------|
| `登校` または `checkin` | 登校フローを開始 |
| `下校` または `checkout` | 下校フローを開始 |
| `履歴` または `history` | 登校履歴を表示 |
| その他のテキスト | ヘルプメッセージ |

### 例1: 「登校」と送信

**送信**: `登校`

**返信**:
```
どの教室を使いますか？

[A教室] [B教室] [C教室]
```

（以降はリッチメニューの場合と同じ）

---

### 例2: 適当なテキストを送信

**送信**: `こんにちは`

**返信**:
```
リッチメニューから操作してください。

・登校
・下校
・登校履歴
```

---

## ❌ 現在対応していないこと

### 1. 自由な会話

**送信**: `今日は何曜日？`

**返信**: ヘルプメッセージのみ（会話はできない）

### 2. 座席番号の手入力

**送信**: `5番の席`

**返信**: 理解できない（必ずクイックリプライから選択）

### 3. 複雑な質問

**送信**: `先月の登校時間は？`

**返信**: 対応していない（現在は当月の履歴のみ）

---

## 📱 実際の使用フロー（イメージ）

### 生徒が塾に到着したとき

```
生徒: （LINEを開く）
生徒: （リッチメニューの「登校」をタップ）

Bot: どの教室を使いますか？
     [A教室] [B教室] [C教室]

生徒: （「A教室」をタップ）

Bot: A教室の座席番号を選択してください
     [1番] [2番] [3番] ... [13番]

生徒: （「5番」をタップ）

Bot: ✅ 登校を記録しました！
     教室: A教室
     座席: 5番
     時刻: 2025/11/06 15:30

     今日も頑張りましょう！
```

### 生徒が帰るとき

```
生徒: （リッチメニューの「下校」をタップ）

Bot: 下校しますか？
     [はい、下校します] [キャンセル]

生徒: （「はい、下校します」をタップ）

Bot: ✅ 下校を記録しました！
     勉強時間: 2時間30分

     お疲れ様でした！
```

---

## 🔍 デバッグ方法

### ローカルでテストする場合

1. サーバーを起動
   ```bash
   npm run dev
   ```

2. ngrokでトンネル作成
   ```bash
   ngrok http 3000
   ```

3. LINE DevelopersのWebhook URLを更新
   ```
   https://xxxx.ngrok-free.app/webhook
   ```

4. LINEからメッセージを送信

5. ターミナルでログを確認
   ```
   [2025-11-06 15:30:00] POST /webhook
   Body: { events: [...] }
   Postback受信: checkin { action: 'checkin' }
   ```

---

## 🐛 トラブルシューティング

### Q: 何を送っても反応しない

**原因:**
- Webhookが動作していない
- Webhook URLが間違っている
- 応答メッセージがオンになっている

**確認:**
1. Vercelのログを確認
2. LINE Developers → Webhook URL → 「検証」をクリック
3. 応答メッセージが**オフ**になっているか確認

---

### Q: 2つメッセージが返ってくる

**原因:** 応答メッセージがオンになっている

**解決:** LINE Developers → 応答メッセージ → **オフ**

---

### Q: 登校済みなのにまた登校できる

**原因:** 下校していない

**仕様:** 下校してから再度登校してください

---

### Q: 履歴が表示されない

**原因:** まだ登校記録が無い

**解決:** 一度登校・下校してから確認

---

## 📝 メッセージ一覧

### ウェルカムメッセージ

```
学習塾登校管理システムへようこそ！

リッチメニューから操作してください。
・登校: 教室に着いたら押してください
・下校: 帰るときに押してください
・登校履歴: あなたの記録を確認できます
```

### 登校成功メッセージ

```
✅ 登校を記録しました！

教室: A教室
座席: 5番
時刻: 2025/11/06 15:30

今日も頑張りましょう！
```

### 登校済みエラー

```
既に登校記録があります。下校してから再度登校してください。
```

### 下校成功メッセージ

```
✅ 下校を記録しました！

勉強時間: 2時間30分

お疲れ様でした！
```

### 下校エラー（未登校）

```
登校記録がありません。先に登校してください。
```

### 履歴なしメッセージ

```
まだ登校記録がありません。
```

### エラーメッセージ

```
申し訳ございません。エラーが発生しました。
もう一度お試しください。
```

---

## 🎯 まとめ

### 基本的な使い方

1. **登校**: リッチメニューの「登校」→ 教室選択 → 座席番号選択
2. **下校**: リッチメニューの「下校」→ 確認
3. **履歴**: リッチメニューの「登校履歴」→ 表示

### テキストコマンド

- `登校` / `checkin` → 登校開始
- `下校` / `checkout` → 下校確認
- `履歴` / `history` → 履歴表示

### その他

- 友だち追加でウェルカムメッセージ
- それ以外のテキストはヘルプメッセージ

---

## 💡 将来追加できる機能

- AI先生機能（質問応答）
- ランキング表示（月間トップ10など）
- 親へのメール通知
- 開講日カレンダー表示
- 座席の予約機能
- 勉強時間の統計グラフ

これらはPhase 2以降で実装予定です。
