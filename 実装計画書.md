# 実装計画書

## Phase 1: 環境構築とMVP（1-2週間）

### 目標
基本的な登校・下校記録機能を動作させる

### タスク一覧

#### 1.1 プロジェクトセットアップ（1日）
- [ ] Node.jsプロジェクトの初期化
- [ ] 必要なパッケージのインストール
- [ ] ディレクトリ構造の作成
- [ ] .gitignore設定

#### 1.2 外部サービス設定（2-3日）
- [ ] LINE Developersでチャネル作成
  - Messaging API有効化
  - Webhook URL設定（ngrokで開発時テスト）
  - チャネルアクセストークン取得
  - チャネルシークレット取得

- [ ] Supabaseセットアップ
  - プロジェクト作成
  - `supabase_schema.sql`実行
  - APIキー取得（anon key, service role key）

- [ ] Google Sheets設定
  - Google Cloud Consoleでプロジェクト作成
  - Google Sheets API有効化
  - サービスアカウント作成
  - JSONキーダウンロード
  - スプレッドシート作成・共有

#### 1.3 基本実装（4-5日）
- [ ] `src/index.js` - Expressサーバー起動
- [ ] `src/middleware/lineSignature.js` - LINE署名検証
- [ ] `src/config/*.js` - 各種接続設定
- [ ] `src/controllers/webhookController.js` - Webhook受信ロジック
- [ ] `src/repositories/userRepository.js` - ユーザーDB操作
- [ ] `src/repositories/sheetsRepository.js` - Google Sheets操作

#### 1.4 登校機能実装（3-4日）
- [ ] `src/controllers/checkinController.js` - 登校フロー制御
- [ ] `src/services/attendanceService.js` - 出席記録ロジック
- [ ] `src/services/classroomService.js` - 教室情報取得
- [ ] `src/repositories/sessionRepository.js` - セッション管理
- [ ] `src/utils/messageBuilder.js` - LINEメッセージ構築
- [ ] `src/constants/quickReplies.js` - クイックリプライ定義

**登校フロー:**
```
1. ユーザーが「登校」ボタンをタップ
2. 教室選択画面を表示（クイックリプライ）
3. 選択した教室をセッションに保存
4. 座席番号選択画面を表示
5. 座席番号を選択
6. Google Sheetsに記録
7. Supabase usersテーブルを更新（新規ユーザーの場合）
8. 確認メッセージを送信
```

#### 1.5 下校機能実装（1-2日）
- [ ] `src/controllers/checkoutController.js` - 下校フロー制御
- [ ] 下校時刻の記録
- [ ] 滞在時間の計算

#### 1.6 リッチメニュー作成（1日）
- [ ] リッチメニュー画像作成（2500x1686px or 2500x843px）
- [ ] `scripts/setup-richmenu.js` - リッチメニュー登録スクリプト
- [ ] リッチメニューのLINEへの登録

#### 1.7 テストとデバッグ（2-3日）
- [ ] ローカル環境でテスト（ngrok使用）
- [ ] エラーハンドリングの追加
- [ ] ログ機能の実装

---

## Phase 2: 履歴・ランキング機能（1-2週間）

### 目標
生徒が自分の履歴とランキングを確認できる

### タスク一覧

#### 2.1 履歴表示機能（3-4日）
- [ ] `src/controllers/historyController.js` - 履歴表示制御
- [ ] `src/services/rankingService.js` - 集計ロジック
- [ ] Google Sheetsからデータ取得
- [ ] 月間集計の実装
- [ ] Flex Messageでのリッチ表示

**表示内容:**
- 今月の登校日数
- 今月の合計勉強時間
- 直近5回の登校記録

#### 2.2 ランキング機能（3-4日）
- [ ] 月間登校時間ランキングの計算
- [ ] キャッシュ機能の実装（1日1回更新）
- [ ] プライバシー配慮（表示名の設定）
- [ ] ランキング表示（Flex Message）

**ランキング種類:**
- 月間総登校時間ランキング（TOP 10）
- 月間登校日数ランキング（TOP 10）

#### 2.3 定期集計の実装（2日）
- [ ] 日次バッチ処理（ランキング更新）
- [ ] cron設定またはスケジューラー実装

---

## Phase 3: 通知機能（1週間）

### 目標
親にメール通知を送信する

### タスク一覧

#### 3.1 メール通知実装（3-4日）
- [ ] `src/config/email.js` - SendGrid設定
- [ ] `src/services/notificationService.js` - 通知サービス
- [ ] メールテンプレート作成
- [ ] 登校時の通知送信
- [ ] （オプション）下校時の通知送信

#### 3.2 親メールアドレス登録機能（3-4日）
- [ ] 初回登録フローの実装
- [ ] メールアドレス変更機能
- [ ] バリデーション実装

**登録フロー:**
```
1. 初回登校時にメール登録を促す
2. ユーザーがメールアドレスを入力
3. 確認メール送信
4. Supabase usersテーブルに保存
```

---

## Phase 4: オプション機能（1-2週間）

### 目標
AI先生機能と管理画面の実装

### タスク一覧

#### 4.1 AI先生機能（4-5日）
- [ ] `src/controllers/aiController.js` - AI処理制御
- [ ] `src/services/aiService.js` - OpenAI/Claude API連携
- [ ] 質問受付フロー
- [ ] 講師への通知
- [ ] 回答履歴の保存

#### 4.2 開講日カレンダー（1-2日）
- [ ] PDFファイルのホスティング
- [ ] リッチメニューからのリンク設定

#### 4.3 管理画面（オプション）（5-7日）
- [ ] 講師向けダッシュボード
- [ ] 出席状況の可視化
- [ ] 座席状況のリアルタイム表示

---

## Phase 5: デプロイと運用（1週間）

### タスク一覧

#### 5.1 本番環境構築（2-3日）
- [ ] ホスティング先選定（Heroku/Vercel/Cloud Run）
- [ ] 環境変数設定
- [ ] Webhook URLの本番設定
- [ ] SSL証明書設定

#### 5.2 監視・ログ設定（2日）
- [ ] エラーログ監視
- [ ] アクセスログ記録
- [ ] アラート設定

#### 5.3 ドキュメント整備（2-3日）
- [ ] 運用マニュアル作成
- [ ] トラブルシューティングガイド
- [ ] API仕様書作成

---

## 工数見積もり

| Phase | 期間 | 工数（人日） |
|-------|------|------------|
| Phase 1: MVP | 1-2週間 | 12-18日 |
| Phase 2: 履歴・ランキング | 1-2週間 | 8-10日 |
| Phase 3: 通知機能 | 1週間 | 6-8日 |
| Phase 4: オプション機能 | 1-2週間 | 10-14日 |
| Phase 5: デプロイ・運用 | 1週間 | 6-8日 |
| **合計** | **5-8週間** | **42-58日** |

※ 1日あたり4-6時間の作業を想定

---

## リスクと対策

### リスク1: LINE Webhook応答タイムアウト
**内容**: LINEは5秒以内の応答を要求。Google Sheets APIが遅い場合にタイムアウト

**対策**:
- 非同期処理の導入（即座に200 OKを返し、バックグラウンドで処理）
- Google Sheets APIのキャッシュ活用

### リスク2: 座席番号の重複入力
**内容**: 複数の生徒が同じ座席番号を選択する可能性

**対策**:
- リアルタイム座席状況の確認機能
- 警告メッセージの表示（「この座席は使用中の可能性があります」）

### リスク3: Google Sheetsの行数制限
**内容**: Googleスプレッドシートは500万セルまで

**対策**:
- 月次でシートを分ける
- 古いデータのアーカイブ化

### リスク4: メールアドレスの誤入力
**内容**: 親のメールアドレスを間違えて登録

**対策**:
- 確認メール送信（ダブルオプトイン）
- 管理者による修正機能

---

## 次のアクション

1. ✅ 要件定義の最終確認（検討事項の決定）
2. ⬜ 外部サービスのアカウント作成
3. ⬜ 開発環境の構築
4. ⬜ Phase 1の実装開始
